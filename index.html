<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>BAMITANの思い出屋さん | 無料QRコードジェネレーター＆かわいいスライドショー</title>
  <meta name="description" content="BAMITANの思い出屋さんは、無料で高品質なQRコードを作成し、かわいいマスコットと一緒に画像スライドショー動画も生成できるWebツールです。URL・テキスト・電話番号などを簡単にQR化！" />
  <meta name="keywords" content="QRコード, 無料, ジェネレーター, スライドショー, 画像, 動画, BAMITAN" />
  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="BAMITANの思い出屋さん | 無料QRコードジェネレーター＆かわいいスライドショー" />
  <meta property="og:description" content="BAMITANの思い出屋さんは、無料で高品質なQRコードを作成し、画像スライドショー動画も生成できるWebツールです。" />
  <meta property="og:image" content="https://bamitan.github.io/mascot_og.png" />
  <meta property="og:url" content="https://bamitan.github.io/" />
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="BAMITANの思い出屋さん" />
  <meta name="twitter:description" content="無料でQRコードとスライドショー動画を作成！" />
  <meta name="twitter:image" content="https://bamitan.github.io/mascot_og.png" />
  <!-- JSON-LD 構造化データ -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "BAMITANの思い出屋さん",
    "url": "https://bamitan.github.io/",
    "description": "無料で高品質なQRコードを作成し、かわいいマスコットとスライドショー動画も生成できるWebツールです。",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://bamitan.github.io/?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="mascot.png">
  <style>
    /* 共通スタイル */
    * {
      -webkit-tap-highlight-color: transparent;
      box-sizing: border-box;
    }
    
    :root {
      /* Mascot-inspired palette */
      --primary: #8b5e3c; /* rich chocolate brown */
      --secondary: #d8b98c; /* kinako beige */
      --accent: #c77f2e; /* caramel orange */
      --bg-start: #faf6f0; /* ivory */
      --bg-end: #f1e3d2; /* cream beige */
      /* old colors removed*/
      
      
      --text: #333;
    }
    body {
      position:relative; /* for pseudo */
      display:flex;
      justify-content:center;
      align-items:flex-start;
      gap:1.5rem;
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 2rem 1rem;
    }
    .central{display:flex;flex-direction:column;align-items:center;gap:2rem;}
    .container {
      max-width: 100%;
      width: 100%;
      margin: 0 auto;
      padding: 15px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    @media (min-width: 768px) {
      .container {
        max-width: 800px;
        padding: 20px;
      }
    }
    h1 {text-align:center;margin-top:0;}
    input[type="text"], input[type="file"], select {
      width: 100%;
      padding: 12px 15px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      -webkit-appearance: none;
    }
    
    /* スマホ用の入力フィールド調整 */
    @media (max-width: 480px) {
      input[type="text"], select {
        font-size: 16px; /* iOSでズームを防ぐ */
        padding: 14px 15px;
      }
      
      input[type="file"] {
        font-size: 14px;
      }
    }
    button, a.button, .primary-btn {
      background: var(--primary);
      color:#fff;
      display: inline-block;
      margin-top: 1rem;
      padding: .6rem 1.2rem;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 120px;
      text-align: center;
      -webkit-appearance: none;
    }
    
    @media (max-width: 480px) {
      .button, .primary-btn {
        padding: 12px 20px;
        font-size: 0.9rem;
        min-width: 100px;
      }
    }
    button:disabled {opacity:.6;cursor:not-allowed;}
    #qr-output {text-align:center;margin-top:1.5rem;}
    #history {
      margin-top: 2rem;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 1rem;
    }

    #history img {width:100%;height:auto;border:1px solid #ccc;border-radius:4px;cursor:pointer;}
    .status{margin-top:.5rem;font-size:.9rem;color:#e74c3c;}
    #history p {font-size: .75rem; text-align: center; word-wrap: break-word; margin: .25rem 0 0;}
    /* カラープリセット */
    #preset-colors{display:flex;gap:.5rem;margin-bottom:.75rem;flex-wrap:wrap;}
    .color-swatch{width:24px;height:24px;border:2px solid #ccc;border-radius:4px;cursor:pointer;}
    .color-swatch.selected{outline:3px solid var(--accent);}
    /* 絵文字プリセット */
    #emoji-preset{display:flex;gap:.4rem;margin:.75rem 0;flex-wrap:wrap;justify-content:center;}
    .emoji-choice{font-size:1.5rem;cursor:pointer;user-select:none;padding:.2rem .35rem;border:1px solid #ccc;border-radius:4px;transition:transform .1s;}
    .emoji-choice.selected{outline:2px solid var(--accent);transform:scale(1.1);}
    .ads {
      display: none; /* スマホでは非表示 */
    }
    
    @media (min-width: 1200px) {
      .ads {
        display: flex;
        position: fixed;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        flex-direction: column;
        gap: 20px;
      }
    }
    .ad-item{position:relative;width:120px;height:120px;background:#f1f1f1;border:2px dashed #ccc;border-radius:8px;display:flex;justify-content:center;align-items:center;color:#888;font-size:.9rem;overflow:hidden;cursor:pointer;transition:transform .2s;}
    .ad-item:hover{transform:scale(1.05);box-shadow:0 4px 10px rgba(0,0,0,.1);} 
    .ad-mascot{position:absolute;top:-25px;right:-15px;width:60px;animation:float 3s ease-in-out infinite;pointer-events:none;}
    @keyframes float{0%{transform:translateY(0);}50%{transform:translateY(8px);}100%{transform:translateY(0);}}

    /* 追加スタイル */
    .mascot{position:fixed;top:10px;left:auto;right:10px;width:140px;pointer-events:auto;cursor:grab;user-select:none;z-index:10;transition:left 2s linear, top 2s linear;animation:mascotWiggle 4s ease-in-out infinite;}/* mascot */
    @keyframes mascotWiggle{0%{transform:rotate(-3deg);}50%{transform:rotate(3deg);}100%{transform:rotate(-3deg);}}
    button,a.button{transition:background .2s;}
    .banner{display:inline-block;padding:1rem 2.5rem;border-radius:18px;box-shadow:0 8px 14px rgba(0,0,0,.5) inset,0 6px 12px rgba(0,0,0,.35);margin-bottom:1.4rem;border:5px solid #5e3e1e;
      background:
        repeating-linear-gradient(45deg,#be8a55 0 12px,#a46f37 12px 24px),
        linear-gradient(180deg,#e0b67e 0%,#a87843 100%);
    }
    .banner h1{
      font-family:'Mochiy Pop One','Poppins',sans-serif;
      font-size:2.8rem;
      font-weight:900;
      color:#fff9d0;
      -webkit-text-stroke:2.5px #31200a;
      text-shadow:0 4px 6px rgba(0,0,0,.5);
      white-space:nowrap;
    }
    button:hover,a.button:hover{background:var(--accent);opacity:.9;}

    /* ウォーターマーク背景 */
    body::before{
      content:'';
      position:fixed;
      top:50%;
      left:50%;
      width:800px;
      height:800px;
      transform:translate(-50%,-50%);
      background:url('mascot.png') center/contain no-repeat;
      opacity:0.15;
      pointer-events:none;
      filter:blur(1px);
    }
    /* -------- Slideshow styles -------- */
    #slideshow-section h2{margin-top:0;text-align:center;}
    #slide-preview{display:grid;grid-template-columns:repeat(8,1fr);gap:.5rem;margin-top:1rem;}
    .slide-thumb{width:100%;height:80px;object-fit:cover;border:2px solid #ccc;border-radius:6px;cursor:move;transition:transform .15s,border-color .2s;}
    .slide-thumb:hover{transform:scale(1.05);border-color:var(--accent);}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;background:rgba(0,0,0,.7);z-index:200;}
    .modal img{max-width:90%;max-height:90%;border:8px solid #fff;border-radius:8px;box-shadow:0 0 20px rgba(0,0,0,.5);} 
    .modal .close{position:absolute;top:20px;right:30px;font-size:2.5rem;color:var(--secondary);cursor:pointer;text-shadow:0 0 6px rgba(0,0,0,.4);}
    .controls{position:absolute;bottom:25px;left:50%;transform:translateX(-50%);display:flex;gap:.5rem;align-items:center;}
    .controls button{padding:.45rem .7rem;font-size:1.05rem;background:var(--primary);color:#fff;border:none;border-radius:6px;box-shadow:0 2px 5px rgba(0,0,0,.15);transition:transform .1s,background .2s;}
    .controls button:hover{background:var(--accent);transform:translateY(-2px);}
    #face-grid img{width:100px;height:100px;object-fit:cover;border:2px solid #ccc;border-radius:4px;cursor:pointer;}
    #face-grid img.selected{outline:3px solid var(--accent);}
    .modal-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:2.2rem;font-family:'Mochiy Pop One','Poppins',sans-serif;text-align:center;max-width:90%;white-space:pre-wrap;}
    /* animations */
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    @keyframes zoomIn{from{transform:translate(-50%,-50%) scale(0.8);}to{transform:translate(-50%,-50%) scale(1);}}
    @keyframes slideIn{from{transform:translate(-150%, -50%);}to{transform:translate(-50%,-50%);}}
    @keyframes rotateIn{from{transform:translate(-50%,-50%) rotate(-180deg) scale(0.5);}to{transform:translate(-50%,-50%) rotate(0) scale(1);}}
    @keyframes flipIn{from{transform:translate(-50%,-50%) rotateY(90deg);}to{transform:translate(-50%,-50%) rotateY(0);}}
    @keyframes bounceIn{0%{transform:translate(-50%,-60%);}60%{transform:translate(-50%,-48%);}80%{transform:translate(-50%,-52%);}100%{transform:translate(-50%,-50%);}}
    .fade{animation:fadeIn 1s ease-in-out both;}
    .zoom{animation:zoomIn 1s ease-in-out both;}
    .slide{animation:slideIn 1s ease-in-out both;}
    .rotate{animation:rotateIn 1s ease-in-out both;}
    .flip{animation:flipIn 1s ease-in-out both;}
    .bounce{animation:bounceIn 1s ease-in-out both;}
    .hoop{position:fixed;bottom:10px;right:10px;width:140px;pointer-events:none;opacity:0.9;}
    .score-panel {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 300;
      background: rgba(0,0,0,.6);
      padding: 0.6rem 1rem;
      border-radius: 8px;
      color: #fff;
      font-family: 'Mochiy Pop One', 'Poppins', sans-serif;
      text-align: center;
      width: 90%;
      max-width: 300px;
    }
    
    @media (min-width: 768px) {
      .score-panel {
        top: 390px;
        right: 20px;
        left: auto;
        bottom: auto;
        transform: none;
        width: auto;
        max-width: none;
        text-align: right;
      }
    }
    .score-panel span{display:block;font-size:1.1rem;}
    .score-panel .best{color:#ffd95c;font-size:1rem;}
    .score-panel .alltime{color:#ff6b6b;font-size:1rem;}
    .mascot.dragging{cursor:grabbing;transition:none;}
    /* --- cute overrides --- */
    .primary-btn{background:var(--primary);color:#fff;border:none;border-radius:6px;padding:.6rem 1.2rem;box-shadow:0 2px 5px rgba(0,0,0,.15);transition:transform .1s,background .2s;}
    .primary-btn:hover{background:var(--accent);transform:translateY(-2px);}   
    .button{background:var(--secondary);color:#333;border-radius:6px;padding:.5rem 1rem;border:none;transition:background .2s;}
    .button:hover{background:#ffe47d;}
    #slide-preview .slide-thumb.selected{border-color:var(--accent);} 
    .controls button{background:var(--primary)!important;color:#fff;border:none;border-radius:6px;box-shadow:0 2px 5px rgba(0,0,0,.15);}
    .controls button:hover{background:var(--accent)!important;transform:translateY(-2px);}  
    .modal .close:hover{transform:rotate(90deg);}  
    /* cute labels */
    #slideshow-section label{font-family:'Mochiy Pop One','Poppins',sans-serif;color:var(--primary);font-size:1rem!important;font-weight:600;}
    #slideshow-section select,#slideshow-section input[type="number"]{border:2px solid var(--primary);border-radius:4px;padding:.2rem .4rem;}
  
  </style>
  <style>
    /* Hide slideshow feature and ads */
    #slideshow-section,
    #slideshow-modal,
    .ads {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- 左広告 -->
  <aside class="ads">
    <div class="ad-item"><span>広告1</span></div>
    <div class="ad-item"><span>広告2</span></div>
    <div class="ad-item"><span>広告3</span></div>
  </aside>

  <!-- メインツール --><div class="central">
  <img class="mascot" src="mascot.png" alt="マスコット">
  <div class="container" style="text-align:center;">
    <div class="banner"><h1>BAMITANのQR屋さん</h1></div>
    <p id="visitor-count" style="text-align:right;font-size:.9rem;margin-top:-1rem;margin-bottom:1rem;color:#555;">訪問者数: 0</p>
    
    
    <input type="text" id="title-input" placeholder="QR名 (任意)" style="width:100%;padding:.6rem;border:1px solid #ccc;border-radius:4px;font-size:1rem;margin-bottom:.75rem;">
    <label style="display:block;margin-bottom:.75rem;font-size:.9rem;">QRカラー:
      <input type="color" id="color-input" value="#000000" style="margin-left:.5rem;vertical-align:middle;">
    </label>
    <div id="preset-colors">
      <span class="color-swatch selected" data-color="#000000" style="background:#000000;"></span>
      <span class="color-swatch" data-color="#6a56a5" style="background:#4b3c86;"></span>
      <span class="color-swatch" data-color="#f1c40f" style="background:#f1c40f;"></span>
      <span class="color-swatch" data-color="#27ae60" style="background:#27ae60;"></span>
      <span class="color-swatch" data-color="#ff6b6b" style="background:#ff6b6b;"></span>
      <span class="color-swatch" data-color="#d77cd9" style="background:#d77cd9;"></span>
      <span class="color-swatch" data-color="#16a085" style="background:#16a085;"></span>
      <span class="color-swatch" data-color="#54a0ff" style="background:#54a0ff;"></span>
    </div>
    <label style="display:block;margin-bottom:.75rem;font-size:.9rem;">ドット形状:
      <select id="shape-select" style="margin-left:.5rem;">
        <option value="square">四角</option>
        <option value="dots">丸</option>
      </select>
    </label>
    <textarea id="qr-input" placeholder="URL、テキスト、電話番号などを入力してください"></textarea>
    <div id="emoji-preset">
      <span class="emoji-choice" data-emoji="⭐️">⭐️</span>
      <span class="emoji-choice" data-emoji="❤️">❤️</span>
      <span class="emoji-choice" data-emoji="🔥">🔥</span>
      <span class="emoji-choice" data-emoji="😊">😊</span>
      <span class="emoji-choice" data-emoji="🎉">🎉</span>
      <span class="emoji-choice" data-emoji="💡">💡</span>
      <span class="emoji-choice" data-emoji="✅">✅</span>
      <span class="emoji-choice" data-emoji="❌">❌</span>
      <span class="emoji-choice" data-emoji="🤖">🤖</span>
      <span class="emoji-choice" data-emoji="🐱">🐱</span>
      <span class="emoji-choice" data-emoji="🐶">🐶</span>
      <span class="emoji-choice" data-emoji="🍀">🍀</span>
      <span class="emoji-choice" data-emoji="🌈">🌈</span>
      <span class="emoji-choice" data-emoji="🏀">🏀</span>
      <span class="emoji-choice" data-emoji="🎵">🎵</span>
      <span class="emoji-choice" data-emoji="🚀">🚀</span>
      <span class="emoji-choice" data-emoji="📚">📚</span>
      <span class="emoji-choice" data-emoji="🍣">🍣</span>
      <span class="emoji-choice" data-emoji="🎂">🎂</span>
      <span class="emoji-choice" data-emoji="🖼️">🖼️</span>
      <span class="emoji-choice" data-emoji="🎮">🎮</span>
      <span class="emoji-choice" data-emoji="👑">👑</span>
      <span class="emoji-choice" data-emoji="🌸">🌸</span>
      <span class="emoji-choice" data-emoji="🌞">🌞</span>
      <span class="emoji-choice" data-emoji="👻">👻</span>
      <span class="emoji-choice" data-emoji="🦄">🦄</span>
      <span class="emoji-choice" data-emoji="🧡">🧡</span>
      <span class="emoji-choice" data-emoji="🏆">🏆</span>
      <span class="emoji-choice" data-emoji="🐼">🐼</span>
      <span class="emoji-choice" data-emoji="🐸">🐸</span>
      <span class="emoji-choice" data-emoji="🍕">🍕</span>
      <span class="emoji-choice" data-emoji="🥳">🥳</span>
      <span class="emoji-choice" data-emoji="🏝️">🏝️</span>
      <span class="emoji-choice" data-emoji="⚽">⚽</span>
      <span class="emoji-choice" data-emoji="📸">📸</span>
      <span class="emoji-choice" data-emoji="🧩">🧩</span>
      <span class="emoji-choice" data-emoji="🛡️">🛡️</span>
      <span class="emoji-choice" data-emoji="🍼">🍼</span>
      <span class="emoji-choice" data-emoji="🏡">🏡</span>
    </div>
    <label style="display:block;margin-top:1rem;font-size:.9rem;">ロゴ画像(任意):
      <input type="file" id="logo-input" accept="image/*" style="margin-top:.25rem;">
    </label>
    <button id="generate-btn" class="primary-btn">QRコード生成</button>
    <p id="status-msg" class="status"></p>
    <a id="download-btn" class="button" href="#" download="qrcode.png" style="display:none;">PNGをダウンロード</a>
    <div id="qr-output">
      <img id="qr-image" alt="QRコード" style="display:none; max-width: 260px; height:auto;" />
    </div>
    <h2 style="display:inline-block;">履歴</h2><button id="clear-history" class="button" style="margin-left:1rem;padding:.3rem .8rem;font-size:.8rem;">履歴をクリア</button>
    <div id="history"></div>
    <!-- face selection modal -->
  <div id="face-modal" class="modal" style="display:none;">
    <span class="close">&#10005;</span>
    <div id="face-grid" style="display:grid;grid-template-columns:repeat(auto-fill,100px);gap:.5rem;padding:1rem;max-height:70vh;overflow:auto;"></div>
    <div style="text-align:center;margin:1rem 0 0;display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
      <button id="add-faces" class="primary-btn" disabled>選択した顔を追加</button>
      <button id="add-all-faces" class="button">すべて追加</button>
      <button id="cancel-faces" class="secondary-btn">キャンセル</button>
    </div>
    <p id="selected-count" style="color:#fff;margin:0.5rem 0;text-align:center;">0 枚の写真が選択されます</p>
      <label style="display:flex;align-items:center;justify-content:center;color:#fff;font-size:.9rem;gap:.5rem;margin-bottom:1rem;">
        類似度しきい値:<span id="th-val">0.35</span>
        <input type="range" id="th-slider" min="0.05" max="3.00" step="0.05" value="0.35" style="width:150px;" />
      </label>
  </div>
</div>  <!-- slideshow-section container end -->
  <div class="container" id="slideshow-section" style="display:block;clear:both;margin-top:3rem;width:600px;">
    <div class="banner"><h1 style="margin:0;">BAMITANの思い出屋さん</h1></div>
    <input type="file" id="slide-input" accept="image/*,.heic,.heif,.webp,.avif" multiple style="margin-top:.5rem;">
    <br>
    <label style="font-size:.9rem;">音楽ファイル:
      <input type="file" id="audio-input" accept="audio/*" style="margin-left:.5rem;">
    </label>
    <br>
    <label style="font-size:.9rem;">スライド表示時間(秒):
      <input type="number" id="duration-input" value="2" min="0.2" step="0.1" style="width:80px;margin-left:.5rem;">
    </label>
    <br>
    <label style="font-size:.9rem;">開始メッセージ:
      <input type="text" id="intro-text" placeholder="例: スタート！" style="margin-left:.5rem;width:60%;">
    </label>
    <br>
    <label style="font-size:.9rem;">終了メッセージ:
      <input type="text" id="outro-text" placeholder="例: ありがとう！" style="margin-left:.5rem;width:60%;">
    </label>
    <br>
    <label style="font-size:.9rem;">アニメーション:
      <select id="anim-select" style="margin-left:.5rem;">
        <option value="fade">フェード</option>
        <option value="zoom">ズーム</option>
        <option value="slide">スライド</option>
        <option value="rotate">回転</option>
        <option value="flip">フリップ</option>
        <option value="bounce">バウンス</option>
      </select>
    </label>
    <div style="display:flex;gap:1rem;margin-bottom:.5rem;">
      <button id="extract-faces" class="button">顔を抽出</button>
      <button id="reset-filter" class="button">リセット</button>
      <button id="start-slideshow" class="primary-btn" disabled>動画作成</button>
    </div>
    <div id="slide-preview"></div>
  </div>

  <div id="slideshow-modal" class="modal" style="display:none;">
    <span class="close">&#10005;</span>
    <img src="" alt="slide">
    <div class="modal-text" style="display:none;"></div>
    <div class="controls">
      <button id="prev-slide">←</button>
      <button id="play-pause">⏸</button>
      <button id="next-slide">→</button>
      <input type="text" id="caption-input" placeholder="テロップ" style="width:200px;">
      <button id="save-caption">保存</button>
      <button id="export-video">動画保存</button>
      <button id="finish-slideshow">完了</button>
    </div>
  </div>

</div>
  <!-- 右広告 -->
  <aside class="ads">
    <div class="ad-item"><span>広告4</span></div>
    <div class="ad-item"><span>広告5</span></div>
    <div class="ad-item"><span>広告6</span></div>
  </aside>

  <!-- QRCode.js CDN -->
  <script id="qrcode-lib" src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <!-- QR Code Styling for rounded dots -->
  <script id="qrcode-styling-lib" src="https://cdn.jsdelivr.net/npm/qr-code-styling/lib/qr-code-styling.js"></script>
  <!-- face-api.js for face detection -->
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script>
    (function(){
      // ライブラリ読み込み確認 & フォールバック
      function ensureQrLib(){
        return new Promise((resolve,reject)=>{
          if(typeof QRCode!=='undefined' && QRCode.toDataURL){return resolve();}
          // jsDelivr が失敗した場合に cdnjs へフォールバック
          const cell = 14; const margin = 14;
          const alt = document.createElement('script');
          alt.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js';
          alt.onload = ()=>{
            if(typeof QRCode!=='undefined' && QRCode.toDataURL){resolve();}
            else reject(new Error('QRCode ライブラリ読み込み失敗'));
          };
          alt.onerror = ()=>reject(new Error('QRCode ライブラリ読み込み失敗'));
          document.head.appendChild(alt);
        });
      }
      const input = document.getElementById('qr-input');
      
      const titleInput = document.getElementById('title-input');
      const colorInput = document.getElementById('color-input');
      const shapeSelect = document.getElementById('shape-select');
      const genBtn = document.getElementById('generate-btn');
      const dlBtn = document.getElementById('download-btn');
      const logoInput = document.getElementById('logo-input');
      // canvas 要らない形に変更
      const imgEl = document.getElementById('qr-image');
      const historyDiv = document.getElementById('history');
      // 訪問者数取得（countapi.xyz が解決できない場合は countapi.dev へフォールバック）
      const visitorEl = document.getElementById('visitor-count');
      async function updateVisitor(){
        if(!visitorEl) return;
        try{
          let res = await fetch('https://api.countapi.dev/hit/bamitan-qr/visits?amount=1');
          if(res.status===404){
            // 名前空間が未作成の場合に初期化
            await fetch('https://api.countapi.dev/set/bamitan-qr/visits?value=1');
            res = await fetch('https://api.countapi.dev/get/bamitan-qr/visits');
          }
          if(!res.ok) throw new Error('dev failed');
          const d = await res.json();
          visitorEl.textContent = '訪問者数: '+ d.value;
        }catch(_e){
          try{
            let res = await fetch('https://api.countapi.xyz/hit/qrtool/nagasawa?amount=1');
            if(!res.ok) throw new Error('dev failed');
            const d = await res.json();
            visitorEl.textContent = '訪問者数: '+ d.value;
          }catch(e){
            visitorEl.textContent = '訪問者数: 0';
          }
        }
      }
      updateVisitor();
      // 絵文字プリセット
      let selectedEmoji = '';
      document.querySelectorAll('.emoji-choice').forEach(el=>{
        el.addEventListener('click',()=>{
          document.querySelectorAll('.emoji-choice').forEach(e=>e.classList.remove('selected'));
          el.classList.add('selected');
          selectedEmoji = el.dataset.emoji || '';
        });
      });
      // カラープリセットイベント
      document.querySelectorAll('.color-swatch').forEach(sw=>{
        sw.addEventListener('click',()=>{
          document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('selected'));
          sw.classList.add('selected');
          colorInput.value = sw.dataset.color;
        });
      });

      function generateQR(text, color, shape){
        if(typeof QRCode === 'undefined' || !QRCode.toDataURL){
          // ライブラリがない場合は Google Chart API を利用
          const hex = color.replace('#','');
            const url = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&color=${hex}&bgcolor=FFFFFF&data=${encodeURIComponent(text)}`;
          return Promise.resolve(url);
        }
        if(shape!== 'square'){
    return new Promise(async (resolve,reject)=>{
      try{
        if(typeof QRCodeStyling==='undefined'){
          await new Promise((res,rej)=>{
            const s=document.createElement('script');
            s.src='https://cdn.jsdelivr.net/npm/qr-code-styling/lib/qr-code-styling.js';
            s.onload=res; s.onerror=rej; document.head.appendChild(s);
          });
        }
        const qrStyling = new QRCodeStyling({
          width:260,
          height:260,
          data:text,
          dotsOptions:{type: shape==='square' ? 'square' : 'dots', color: color},
          backgroundOptions:{color:'#FFFFFF'}
        });
        qrStyling.getRawData('png').then(blob=>{
          const reader=new FileReader();
          reader.onload=()=>resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      }catch(e){reject(e);}  
    });
  }
  return new Promise((resolve, reject) => {
          try{
            QRCode.toDataURL(text, { margin: 2, width: 260, color: { dark: color, light: '#FFFFFF' } }, (err, url) => {
              if(err) return reject(err);
              resolve(url);
            });
          }catch(e){
            reject(e);
          }
        });
      }

      function saveToHistory(text, dataUrl, title){
        const history = JSON.parse(localStorage.getItem('qr_history') || '[]');
        // Avoid duplicates of consecutive same item
        if(history.length === 0 || history[0].text !== text){
          history.unshift({text, dataUrl, title});
          if(history.length > 10) history.pop();
          localStorage.setItem('qr_history', JSON.stringify(history));
        }
      }

      function renderHistory(){
        const history = JSON.parse(localStorage.getItem('qr_history') || '[]');
        historyDiv.innerHTML = '';
        history.forEach(item => {
          const wrapper = document.createElement('div');
          const img = new Image();
          img.src = item.dataUrl;
          img.alt = item.text;
          img.title = item.text;
          img.addEventListener('click', () => {
            input.value = item.text;
            generateAndDisplay();
          });
          wrapper.appendChild(img);
          if(item.title){
            const cap=document.createElement('p');
            cap.textContent=item.title;
            wrapper.appendChild(cap);
          }
          historyDiv.appendChild(wrapper);
        });
      }

      async function generateAndDisplay(){
        const statusArea = document.getElementById('status-msg'); // may be null if element missing
        if(statusArea) statusArea.textContent = '';
        const text = input.value.trim();
        const title = titleInput.value.trim();
        if(!text){ if(statusArea) statusArea.textContent='入力が空です';return; }
        const payload = text;
        const color = colorInput.value || '#000000';
        const shape = shapeSelect.value;
        genBtn.disabled = true;
        try{
          try{await ensureQrLib();}catch(_e){/* ライブラリ読込失敗でも API フォールバック */}
          const qrUrl = await generateQR(payload, color, shape);
          // ---- 合成処理 ----
          const finalUrl = await composeWithLogo(qrUrl);
          imgEl.src = finalUrl;
          imgEl.style.display = 'block';
          dlBtn.style.display = 'inline-block';
          dlBtn.href = finalUrl;
          dlBtn.download = (title || 'qrcode') + '.png';
          saveToHistory(payload, finalUrl, title);
          renderHistory();
        }catch(e){
          if(statusArea) statusArea.textContent = 'QRコードの生成に失敗しました: '+ (e.message || e);
          console.error(e);
        }finally{
          genBtn.disabled = false;
        }
      }

      genBtn.addEventListener('click', generateAndDisplay);
      document.getElementById('clear-history').addEventListener('click', ()=>{localStorage.removeItem('qr_history');renderHistory();});
      // Render history on load
      renderHistory();
          // QRとロゴを合成
      function composeWithLogo(qrUrl){
        return new Promise(resolve=>{
          const qrImg=new Image();
          qrImg.crossOrigin='Anonymous';
          qrImg.src=qrUrl;
          qrImg.onload=()=>{
            const size=260;
            const canvas=document.createElement('canvas');
            canvas.width=canvas.height=size;
            const ctx=canvas.getContext('2d');
            ctx.drawImage(qrImg,0,0,size,size);

            const file=logoInput.files && logoInput.files[0];
            if(file){
              const reader=new FileReader();
              reader.onload=()=>{
                const logo=new Image();
                logo.onload=()=>{
                  const logoSize=60;
                  const x=(size-logoSize)/2;
                  const y=(size-logoSize)/2;
                  ctx.drawImage(logo,x,y,logoSize,logoSize);
                  resolve(canvas.toDataURL());
                };
                logo.src=reader.result;
              };
              reader.readAsDataURL(file);
            }else{
              if(selectedEmoji){
                ctx.font='60px "Apple Color Emoji","Segoe UI Emoji",sans-serif';
                ctx.textAlign='center';
                ctx.textBaseline='middle';
                ctx.fillText(selectedEmoji,size/2,size/2);
              }
              resolve(canvas.toDataURL());
            }
          };
        });
      }

/* duplicate old composeWithLogo
          const qrImg = new Image();
          qrImg.crossOrigin = 'Anonymous';
          qrImg.src = qrUrl;
          qrImg.onload = async () => {
            const canvas = document.createElement('canvas');
            const size = 260;
            canvas.width = canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(qrImg, 0, 0, size, size);

            const file = logoInput.files && logoInput.files[0];
            if(file){
              const reader = new FileReader();
              reader.onload = () => {
                const logoImg = new Image();
                logoImg.onload = () => {
                  const logoSize = 60; // px
                  const x = (size - logoSize)/2;
                  const y = (size - logoSize)/2;
                  ctx.fillStyle = '#fff';
                  ctx.font = `bold ${14-2}px Poppins, monospace`; // 白背景
                  ctx.drawImage(logoImg, x, y, logoSize, logoSize);
                  resolve(canvas.toDataURL());
              };
              logoImg.src = reader.result;
            };
            reader.readAsDataURL(file);
          }else{
    if(selectedEmoji){
      ctx.font = '60px "Apple Color Emoji", "Segoe UI Emoji", sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(selectedEmoji, size/2, size/2);
          };
          logoImg.src = reader.result;
        };
        reader.readAsDataURL(file);
      }else{
        if(selectedEmoji){
          ctx.font = '60px "Apple Color Emoji", "Segoe UI Emoji", sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(selectedEmoji, size/2, size/2);
        }
        resolve(canvas.toDataURL());
      }          }
          };
        });
       }
*/
 
       renderHistory();
          // --- mascot random movement ---
      const mascotEl = document.querySelector('.mascot');
      let hoopEl = document.querySelector('.hoop');
      let hoopMoveTimer = null;
      // hoop moves only after point threshold
      let hoopMoveInterval = 1500;
      // --- score panel setup ---
      const todayKey = 'bestScore_' + new Date().toLocaleDateString();
       let bestScore = parseInt(localStorage.getItem(todayKey) || '0');
       const allTimeKey = 'allTimeBestScore';
       let allTimeScore = parseInt(localStorage.getItem(allTimeKey) || '0');
       let scorePanel = document.getElementById('score-panel');
       if(!scorePanel){
         scorePanel = document.createElement('div');
         scorePanel.id = 'score-panel';
         scorePanel.className = 'score-panel';
         scorePanel.innerHTML = `<span id="current-score">0 ゴール</span><span class="best" id="best-score">今日の最高: ${bestScore}</span><span class="alltime" id="alltime-score">史上最高: ${allTimeScore}</span>`;
         document.body.appendChild(scorePanel);
       }
       const hoopCounterEl = document.getElementById('current-score');
       const bestEl = document.getElementById('best-score');
       const allTimeEl = document.getElementById('alltime-score');
      let mascotTouchCount = 0;
      function adjustDifficulty(){
        let newInterval = 5000;
        let newMargin = 40;
        if(mascotTouchCount >= 20){ newInterval = 1000; newMargin = 10; }
        else if(mascotTouchCount >= 10){ newInterval = 2000; newMargin = 20; }
        else if(mascotTouchCount >= 5){ newInterval = 3000; newMargin = 30; }
        // update mascot speed if needed
        if(newInterval !== moveInterval){
          moveInterval = newInterval;
          clearInterval(moveTimer);
          moveTimer = setInterval(moveMascot, moveInterval);
        }
        radiusMargin = newMargin;
        // start hoop movement after 20 points
        if(mascotTouchCount >= 20 && !hoopMoveTimer){
          if(!hoopEl){ hoopEl = document.querySelector('.hoop'); }
          if(hoopEl){
            moveHoop();
            hoopMoveTimer = setInterval(moveHoop, hoopMoveInterval);
          }
        }
      }
      function updateHoopCounter(){
        mascotTouchCount++;
        hoopCounterEl.textContent = mascotTouchCount + ' ゴール';
         if(mascotTouchCount > bestScore){
           bestScore = mascotTouchCount;
           bestEl.textContent = '今日の最高: ' + bestScore;
           localStorage.setItem(todayKey, bestScore);
         }
         if(mascotTouchCount > allTimeScore){
           allTimeScore = mascotTouchCount;
           allTimeEl.textContent = '史上最高: ' + allTimeScore;
           localStorage.setItem(allTimeKey, allTimeScore);
         }
        adjustDifficulty();
        // simple pop animation
        hoopCounterEl.style.transform = 'scale(1.3)';
        setTimeout(()=>{hoopCounterEl.style.transform='scale(1)';},150);
      }
      // --- drag to hoop ---
      let isDragging = false, offsetX = 0, offsetY = 0, origX = 0, origY = 0;
      function startDrag(e){
        e.preventDefault();
        isDragging = true;
        mascotEl.classList.add('dragging');
        const rect = mascotEl.getBoundingClientRect();
        const pointX = (e.touches?e.touches[0].clientX:e.clientX);
        const pointY = (e.touches?e.touches[0].clientY:e.clientY);
        origX = rect.left;
        origY = rect.top;
        offsetX = pointX - rect.left;
        offsetY = pointY - rect.top;
        mascotEl.style.transition = 'none';
        clearInterval(moveTimer);
      }
      function duringDrag(e){
        if(!isDragging) return;
        e.preventDefault();
        const pointX = (e.touches?e.touches[0].clientX:e.clientX);
        const pointY = (e.touches?e.touches[0].clientY:e.clientY);
        const x = pointX - offsetX;
        const y = pointY - offsetY;
        mascotEl.style.left = x + 'px';
        mascotEl.style.top = y + 'px';
      }
      function endDrag(){
        mascotEl.style.transition = '';
        if(!isDragging) return;
        isDragging = false;
        mascotEl.classList.remove('dragging');
        const hoopRect = document.querySelector('.hoop').getBoundingClientRect();
        const mascotRect = mascotEl.getBoundingClientRect();
        // calculate center distance for more forgiving hit detection
        const mascotCenterX = mascotRect.left + mascotRect.width/2;
        const mascotCenterY = mascotRect.top + mascotRect.height/2;
        const hoopCenterX = hoopRect.left + hoopRect.width/2;
        const hoopCenterY = hoopRect.top + hoopRect.height/2;
        const dist = Math.hypot(mascotCenterX - hoopCenterX, mascotCenterY - hoopCenterY);
        const radius = Math.max(hoopRect.width, hoopRect.height)/2 + radiusMargin;
        if(dist < radius){
          updateHoopCounter();
          // return mascot instantly to original position
          mascotEl.style.transition = 'none';
          mascotEl.style.left = origX + 'px';
          mascotEl.style.top = origY + 'px';
          setTimeout(()=>{mascotEl.style.transition='';},50);
        }
        moveTimer = setInterval(moveMascot, 5000);
      }
      // use pointer events for consistency
      mascotEl.addEventListener('pointerdown', startDrag);
      document.addEventListener('pointermove', duringDrag);
      document.addEventListener('pointerup', endDrag);
      function moveMascot(){
        if(!mascotEl) return;
        const maxX = window.innerWidth - mascotEl.offsetWidth - 20;
        const maxY = window.innerHeight - mascotEl.offsetHeight - 20;
        const x = Math.random()*maxX;
        const y = Math.random()*maxY;
        mascotEl.style.left = x + 'px';
        mascotEl.style.top = y + 'px';
      }
      function moveHoop(){
        if(!hoopEl) return;
        const maxX = window.innerWidth - hoopEl.offsetWidth - 20;
        const x = Math.random()*maxX;
        const maxY = window.innerHeight - hoopEl.offsetHeight - 20;
        const y = Math.random()*maxY;
        hoopEl.style.left = x + 'px';
        hoopEl.style.top = y + 'px';
        hoopEl.style.right = 'unset';
        hoopEl.style.bottom = 'unset';
      }
      moveMascot();
      let moveInterval = 5000;
      let moveTimer = setInterval(moveMascot, moveInterval);
      let radiusMargin = 40;
  })();
  </script>

  <script>
  (function(){
    const slideInput = document.getElementById('slide-input');
    const audioInput = document.getElementById('audio-input');
    const durationInput = document.getElementById('duration-input');
    const slidePreview = document.getElementById('slide-preview');
    const introInput = document.getElementById('intro-text');
    const outroInput = document.getElementById('outro-text');
    const animSelect = document.getElementById('anim-select');
    const startBtn = document.getElementById('start-slideshow');
    const modal = document.getElementById('slideshow-modal');
    if(!slideInput || !startBtn || !modal) return;

    const modalImg = modal.querySelector('img');
    const modalText = modal.querySelector('.modal-text');
    const closeBtn = modal.querySelector('.close');
    const prevBtn = document.getElementById('prev-slide');
    const nextBtn = document.getElementById('next-slide');
    const playPauseBtn = document.getElementById('play-pause');
    const captionInputEl = document.getElementById('caption-input');
    const saveCaptionBtn = document.getElementById('save-caption');
     const extractBtn = document.getElementById('extract-faces');
     
     const faceModal = document.getElementById('face-modal');
     const faceGrid = document.getElementById('face-grid');
     const addFacesBtn   = document.getElementById('add-faces');
    const cancelFacesBtn = document.getElementById('cancel-faces');
     const addAllBtn = document.getElementById('add-all-faces');
     const faceClose = faceModal ? faceModal.querySelector('.close'):null;
     let faceApiLoaded = false;
    // グローバルな顔クラスター情報を保持
    let globalGroups = []; // [{rep:Float32Array, items:[thumbs], originals:Set<slideObj>}]
     let selectedThumbs = new Set();
    const finishBtn = document.getElementById('finish-slideshow');
     const exportBtn = document.getElementById('export-video');
    let slides = [], allSlides = [], currentIdx = 0, timer = null, bgAudio = null, isPlaying = false, intervalMs = 2000;
    // --- 類似度しきい値 UI ---
    const thSlider = document.getElementById('th-slider');
    const thVal    = document.getElementById('th-val');
    let similarityThreshold = parseFloat(thSlider.value); // 0.10〜1.00
    thSlider.addEventListener('input', ()=>{
      similarityThreshold = parseFloat(thSlider.value);
      thVal.textContent = similarityThreshold.toFixed(2);
    });

    slideInput.addEventListener('change', ()=>{
      slides = Array.from(slideInput.files || []).map(f=>({file:f, caption:''}));
      allSlides = slides.slice();
      slidePreview.innerHTML='';
      slides.forEach((obj,idx)=>{
        const url = URL.createObjectURL(obj.file);
        const img = document.createElement('img');
        img.src = url;
        img.className = 'slide-thumb';
        img.title = 'クリックしてテロップ入力';
        obj.thumb = img;
        img.addEventListener('click',()=>{
          const cap = prompt('この画像に表示するテロップ（空で取消）', obj.caption || '');
          if(cap!==null){ obj.caption = cap.trim(); img.style.borderColor = obj.caption ? '#48c280' : '#ccc'; }
        });
        slidePreview.appendChild(img);
      });
      const hasFiles = slides.length>0;
      startBtn.disabled = !hasFiles;
      extractBtn.disabled = !hasFiles;
      document.getElementById('reset-filter').style.display = 'inline-block';
    });

    startBtn.addEventListener('click', ()=>{
      // スライド構成を毎回組み立て直す
      const rawSlides = Array.from(slideInput.files || []);
      if(!rawSlides.length && !slides.length) return;

      if(timer){ clearInterval(timer); timer=null; }
      if(bgAudio){ bgAudio.pause(); bgAudio.currentTime = 0; }

      const duration = parseFloat(durationInput.value) || 2;
      intervalMs = duration * 1000;

      const combined = [];
      const introT = introInput.value.trim();
      if(introT) combined.push({type:'text', content:introT});

      // 選択した顔写真を先頭に、その後アップロード順
      slides.forEach(obj=>combined.push({type:'image', file: obj.file, caption: obj.caption}));

      const outroT = outroInput.value.trim();
      if(outroT) combined.push({type:'text', content: outroT});

      // --- shuffle images randomly ---
      (function(){
        const imgStart = introT ? 1 : 0;
        const imgEnd = combined.length - (outroT ? 1 : 0);
        const imgs = combined.slice(imgStart, imgEnd);
        for(let i=imgs.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [imgs[i],imgs[j]]=[imgs[j],imgs[i]];}
        combined.splice(imgStart, imgs.length, ...imgs);
      })();
      slides = combined;
      currentIdx = 0;
      showSlide();
      modal.style.display = 'flex';
      isPlaying = true;
      playPauseBtn.textContent = '⏸';

      if(audioInput.files && audioInput.files[0]){
        const audioURL = URL.createObjectURL(audioInput.files[0]);
        bgAudio = new Audio(audioURL);
        bgAudio.play();
      }
      timer = setInterval(nextSlide, intervalMs);
    });

    const resetBtn = document.getElementById('reset-filter');
    const selectedCountEl = document.getElementById('selected-count');
    function updateSelectedCount(){
      const groupSet = new Set(Array.from(selectedThumbs).map(t=>parseInt(t.dataset.group,10)));
      let cnt = 0;
      groupSet.forEach(idx=>{
        const g = globalGroups[idx];
        if(g) cnt += g.originals.size;
      });
      selectedCountEl.textContent = `${cnt} 枚の写真が選択されます`;
      addFacesBtn.disabled = selectedThumbs.size === 0;
    }
    // 顔抽出フィルターの状態を追跡
    let isFaceFilterActive = false;

    resetBtn.addEventListener('click', ()=>{
      // 顔抽出フィルターを無効化して全写真を表示
      isFaceFilterActive = false;
      applyOriginals(allSlides, true);
      
      // 選択状態をリセット
      selectedThumbs.clear();
      updateSelectedCount();
      
      // モーダルが開いていれば閉じる
      if(faceModal.style.display === 'block') {
        faceModal.style.display = 'none';
      }
    });

    function resetAnim(el){ el.classList.remove('fade','zoom','slide','rotate','flip','bounce'); void el.offsetWidth; }

    function showSlide(){
      if(!slides.length) return;
      const item = slides[currentIdx];
      // update caption input field
      if(captionInputEl) captionInputEl.value = item.type==='image' ? (item.caption||'') : '';
      if(!item) return;
      const val = animSelect.value;
      const animClass = ['fade','zoom','slide','rotate','flip','bounce'].includes(val)? val : 'fade';
      resetAnim(modalImg); resetAnim(modalText);
      if(item.type==='image'){
        modalImg.style.display='block';
        modalImg.src = URL.createObjectURL(item.file);
        modalImg.classList.add(animClass);
        if(item.caption){
          modalText.style.display='block';
          modalText.textContent=item.caption;
          modalText.style.top='85%';
          modalText.style.transform='translate(-50%,0)';
          modalText.classList.add(animClass);
        }else{
          modalText.style.display='none';
        }
      }else{
        modalImg.style.display='none';
        modalText.style.display='block';
        modalText.textContent = item.content;
        modalText.style.top='50%';
        modalText.style.transform='translate(-50%,-50%)';
        modalText.classList.add(animClass);
      }
    }

    function nextSlide(){
      currentIdx = (currentIdx + 1) % slides.length;
      showSlide();
    }

    function prevSlide(){
      currentIdx = (currentIdx - 1 + slides.length) % slides.length;
      showSlide();
    }

    prevBtn.addEventListener('click', prevSlide);

    nextBtn.addEventListener('click', ()=>{ nextSlide(); });

    function togglePlay(){
      if(isPlaying){
        clearInterval(timer); timer=null; isPlaying=false; playPauseBtn.textContent='▶︎';
      }else{
        timer = setInterval(nextSlide, intervalMs); isPlaying=true; playPauseBtn.textContent='⏸';
      }
    }
    playPauseBtn.addEventListener('click', togglePlay);

    saveCaptionBtn.addEventListener('click', ()=>{
      const val = captionInputEl.value.trim();
      const item = slides[currentIdx];
      if(item && item.type==='image'){
        item.caption = val;
        if(item.thumb) item.thumb.style.borderColor = val ? '#48c280':'#ccc';
        showSlide();
      }
    });

    function closeModal(){
      modal.style.display='none';
      if(timer) clearInterval(timer);
      if(bgAudio){ bgAudio.pause(); bgAudio.currentTime = 0; }
    }
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', e=>{ if(e.target === modal) closeModal(); });

     // ---- face extraction ----
     async function ensureFaceApi(){
       if(faceApiLoaded) return;
       const modelURL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
       await Promise.all([
         faceapi.nets.ssdMobilenetv1.loadFromUri(modelURL),
         faceapi.nets.faceLandmark68Net.loadFromUri(modelURL),
         faceapi.nets.faceRecognitionNet.loadFromUri(modelURL)
       ]);
       faceApiLoaded = true;
     }

     extractBtn.addEventListener('click', async ()=>{
       await ensureFaceApi();
       selectedThumbs.clear();
       updateSelectedCount();
        globalGroups = []; // クリック毎にリセット
       faceGrid.innerHTML = '<p style="color:#fff;font-size:1rem;grid-column:1/-1;">検出中...</p>';
       faceModal.style.display = 'flex';
       
       
       let foundAny=false;
       for(const obj of slides){
         if(!obj.file) continue;
         const img = await new Promise(res=>{const im=new Image();im.crossOrigin='anonymous';im.onload=()=>res(im);im.src=URL.createObjectURL(obj.file);});
         const detections = await faceapi
            .detectAllFaces(img, new faceapi.SsdMobilenetv1Options({minConfidence:0.75, inputSize: 512}))
            .withFaceLandmarks()
            .withFaceDescriptors();
         if(!detections.length){continue;}
          // --- distance-based grouping ---
          const threshold = similarityThreshold; // UI で変更可能なしきい値
          const colors = ['#ff7675','#74b9ff','#55efc4','#ffeaa7','#fd79a8','#a29bfe','#81ecec'];
          detections.forEach(det=>{
            const {descriptor, detection} = det;
            let groupIdx = -1;
            globalGroups.forEach((g,idx)=>{
              if(groupIdx!==-1) return;
              const dist = faceapi.euclideanDistance(g.rep, descriptor);
              if(dist < threshold) groupIdx = idx;
            });
            if(groupIdx===-1){
               groupIdx = globalGroups.length;
               globalGroups.push({rep: descriptor, items:[], originals:new Set()});
             }
             // always store reference to original photo
             globalGroups[groupIdx].originals.add(obj);
              // obj が含む顔グループ集合を保持
              if(!obj.groups){ obj.groups = new Set(); }
              obj.groups.add(groupIdx);

             // 代表サムネはグループごとに 1 つだけ生成
             if(globalGroups[groupIdx].items.length === 0){
               const {x,y,width,height} = detection.box;        
               const canvas = document.createElement('canvas');
               canvas.width = width; canvas.height = height;
               const ctx = canvas.getContext('2d');
               ctx.drawImage(img,x,y,width,height,0,0,width,height);
               const thumbUrl = canvas.toDataURL();
               const thumb = document.createElement('img');
               thumb.src = thumbUrl;
               thumb.dataset.group = groupIdx;

               // 追加: 元画像のURLとファイル名を保存してツールチップで表示
               thumb.dataset.orig = URL.createObjectURL(obj.file);
               if(obj.file && obj.file.name){ thumb.title = obj.file.name; }
               thumb.style.borderColor = colors[groupIdx % colors.length];

               
           thumb.addEventListener('click', ()=>{
              const g = thumb.dataset.group;
              const sameGroup = faceGrid.querySelectorAll(`img[data-group="${g}"]`);
              const willSelect = !thumb.classList.contains('selected');
              sameGroup.forEach(el=>{
                if(willSelect){
                  el.classList.add('selected');
                }else{
                  el.classList.remove('selected');
                }
              });
             // thumb は sameGroup に含まれるので個別トグルは不要
             // 選択集合を再構築
             selectedThumbs = new Set(faceGrid.querySelectorAll('img.selected'));
             updateSelectedCount();
           });
           faceGrid.appendChild(thumb);
            globalGroups[groupIdx].items.push(thumb);
            } // <<< close if(globalGroups[groupIdx].items.length===0)
             foundAny=true;
         });
       }
     function applyOriginals(list, forceReset = false) {
       if(!list.length) return;
       
       // フィルターが無効化された場合、または強制リセットが要求された場合は全画像を表示
       if(!isFaceFilterActive || forceReset) {
         list = allSlides;
       }
       
       slides = [];
       slidePreview.innerHTML='';
       list.forEach(o=>{
         if(!slides.includes(o)){
           slides.push(o);
           // サムネ Node が無い、または不正な場合は生成し直す
           if(!(o.thumb instanceof Node)){
             const img = document.createElement('img');
             img.src = URL.createObjectURL(o.file);
             img.className = 'slide-thumb';
             o.thumb = img;
           }
           slidePreview.appendChild(o.thumb);
         } 
       });
       startBtn.disabled = false;
     }
     // --- 旧: サムネイルをスライドへ追加（未使用だが互換のため残す） ---
     function addThumbs(thumbs){
       thumbs.forEach(th=>{
         const thumbUrl = th.src;
         fetch(thumbUrl).then(r=>r.blob()).then(blob=>{
           const file = new File([blob], 'face_'+Date.now()+'.png',{type:'image/png'});
           const newObj = {file, caption:'', thumb:null};
           slides.push(newObj);
           const sv = document.createElement('img');
           sv.src = thumbUrl; sv.className='slide-thumb'; newObj.thumb=sv;
           slidePreview.appendChild(sv);
         });
       });
       startBtn.disabled = false;
       faceModal.style.display='none';
     }

     addFacesBtn.addEventListener('click', ()=>{
       if(!selectedThumbs.size) return;
       isFaceFilterActive = true; // 顔抽出フィルターを有効化
       const groupSet = new Set(Array.from(selectedThumbs).map(t=>parseInt(t.dataset.group,10)));
       // 選択した顔を含む画像のみを表示
       const originals = new Set();
        groupSet.forEach(idx=>{
          const g = globalGroups[idx];
          if(!g) return;
          g.originals.forEach(o=>{
            // 画像内のすべての顔が選択済みグループに属している場合のみ採用
            if(!o.groups || Array.from(o.groups).every(gr=>groupSet.has(gr))){
              originals.add(o);
            }
          });
        });
        applyOriginals(Array.from(originals));
     });

     cancelFacesBtn.addEventListener('click', ()=>{
        // 選択をリセットし、全画像プレビューに戻す
        selectedThumbs.clear();
        updateSelectedCount();
        applyOriginals(allSlides);
        
      });

      addAllBtn.addEventListener('click', ()=>{
       const originals = new Set();
       globalGroups.forEach(g=>g.originals.forEach(o=>originals.add(o)));
       applyOriginals(Array.from(originals));
     });
       
     });

     if(faceClose) faceClose.addEventListener('click', ()=>{faceModal.style.display='none';});

    finishBtn.addEventListener('click', closeModal);

    exportBtn.addEventListener('click', async ()=>{
      if(!slides.length) return;
      togglePlay(); // pause during recording
      exportBtn.disabled = true; exportBtn.textContent='生成中...';
      const width = 720, height = 720;
      const canvas = document.createElement('canvas');
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d');
      const stream = canvas.captureStream(30);
      const chunks=[];
      const rec = new MediaRecorder(stream, {mimeType:'video/webm'});
      rec.ondataavailable = e=>{ if(e.data.size) chunks.push(e.data); };
      rec.start();
      const drawSlide = async (item)=>{
        ctx.fillStyle='#000'; ctx.fillRect(0,0,width,height);
        if(item.type==='image'){
          const imgEl = await new Promise(res=>{
            const img = new Image();
            img.onload=()=>res(img); img.src = URL.createObjectURL(item.file);
          });
          // fit image
          let iw = imgEl.width, ih = imgEl.height;
          const ratio = Math.min(width/iw, height/ih);
          iw*=ratio; ih*=ratio;
          ctx.drawImage(imgEl,(width-iw)/2,(height-ih)/2,iw,ih);
          if(item.caption){
            ctx.fillStyle='#fff';
            ctx.font='36px "Poppins",sans-serif';
            ctx.textAlign='center';
            ctx.fillText(item.caption,width/2,height*0.9);
          }
        }else{
          ctx.fillStyle='#000'; ctx.fillRect(0,0,width,height);
          ctx.fillStyle='#fff'; ctx.font='48px "Poppins",sans-serif'; ctx.textAlign='center';
          wrapText(ctx,item.content,width/2,height/2, width*0.8,48);
        }
      };
      const dur = intervalMs;
      for(const s of slides){
        await drawSlide(s);
        await new Promise(r=>setTimeout(r,dur));
      }
      rec.stop();
      await new Promise(res=>rec.onstop=res);
      const blob = new Blob(chunks,{type:'video/webm'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='slideshow.webm'; a.click();
      exportBtn.disabled=false; exportBtn.textContent='動画保存';
    });

    function wrapText(ctx, text, x, y, maxWidth, lineHeight){
      const words = text.split(/\s+/); let line=''; let offsetY=0;
      for(let n=0;n<words.length;n++){
        const test = line + words[n] + ' ';
        if(ctx.measureText(test).width > maxWidth && n>0){
          ctx.fillText(line.trim(),x,y+offsetY);
          line = words[n]+' ';
          offsetY += lineHeight;
        }else{ line = test; }
      }
      ctx.fillText(line.trim(),x,y+offsetY);
    }
  })();
  </script>
<img class="hoop" src="basket_hoop.png" alt="Basket hoop">
</body>
</html>
